{% extends "base.html" %}
{% load staticfiles static %}
{% load i18n mezzanine_tags ffcsa_core_tags %}


{% block main %}
<main id="signup">
  
  <!-- for logged in users -->
  {% if request.user.is_authenticated %}
  <p>{% trans "You're already logged in. If you'd like to create a new account, you'll need to log out first." %}</p>
  {% else %}
  <div class="max-w-screen-lg grid grid-cols-12 gap-10 mx-auto mt-20 p-3">
    <!-- info part -->
    <div class="col-span-12 md:col-span-5 text-base pt-20">
      <h3 class="mb-5 mt-0 text-brown-7 font-bold text-lg	">Thanks for choosing the Full Farm CSA!</h3>
      <p class="mb-3">
        If you haven't done so already, you can check out our current selection of products <a class="text-primary" href="/">here</a>
        and find out more information about our CSA by visiting our <a class="text-primary" target="_blank" href="https://deckfamilyfarm.com/faq/">FAQs</a> page.
      </p>
      <p class="mb-3">
        We encourage all CSA members to visit the Deck Family Farm (in Junction City) at least once
        during or before their time in the CSA, so come check us out! Our open gate policy is Monday - Saturday
        during business hours. Let us know when you may be coming and we can arrange a mini tour.
      </p>
      
      <div class="border-b-2 my-8"></div>
      
      <p class="mb-8">
        Our Portland dropsites are currently full. <a class="text-primary" target="_blank" href="https://26403a96.sibforms.com/serve/MUIEAEe-Lhh9Ij9OVpUCDzojW-Mdekxfy3xZjo7tka8o97OAN5FCESzSdtZnYvRkQkahzra5SB0It2X_txOn8Osv64fHf6t3Cv15W_S8yXTczZbBQfQ7Z_voZO4w2Q48UtGXYMgQaelSC0ni3_GivthfTK9FvMchpVPz-q7Y2JscpW2VjQjQSGgfNoJ56dxcF6ASqRwLc5Qkpa2S">Join our waitlist</a> 
        to be notified when a spot opens up. Thank you for understanding and supporting local farms!
      </p>
      
      <!-- commented iframe -->
      {#  <iframe width="540" height="450"#}
      {#  src="https://26403a96.sibforms.com/serve/MUIEAEe-Lhh9Ij9OVpUCDzojW-Mdekxfy3xZjo7tka8o97OAN5FCESzSdtZnYvRkQkahzra5SB0It2X_txOn8Osv64fHf6t3Cv15W_S8yXTczZbBQfQ7Z_voZO4w2Q48UtGXYMgQaelSC0ni3_GivthfTK9FvMchpVPz-q7Y2JscpW2VjQjQSGgfNoJ56dxcF6ASqRwLc5Qkpa2S"#}
      {#  frameborder="0" scrolling="auto" allowfullscreen#}
      {#  style="display: block;margin-left: auto;margin-right: auto;max-width: 100%;"></iframe>#}
      {#  {% errors_for form %}#}
      <!-- commented iframe -->
    </div>
    <!-- info part -->
    
    
    <!-- form part -->
    <div class="col-span-12 md:col-span-7">
      <div class="text-center mb-10">
        <h1 class="font-bold text-3xl text-gray-900">REGISTER</h1>
        <p>Enter your information to register</p>
      </div>

      <form id="register-form" class="grid grid-cols-12 gap-5 mb-20" method="POST">
        <!-- first name -->
        <div class="col-span-12 md:col-span-6">
          <label for="first_name" class="text-gray-700 px-1">First name *</label>
          <input type="text" name="first_name" id="first_name" v-model="user.first_name" class="input-v" required>
        </div>

        <!-- last name -->
        <div class="col-span-12 md:col-span-6">
          <label for="last_name" class="text-gray-700 px-1">Last name *</label>
          <input type="text" name="last_name" id="last_name" v-model="user.last_name" class="input-v" required>
        </div>

        <!-- email -->
        <div class="col-span-12">
          <label for="email" class="text-gray-700 px-1">Email *</label>
          <input type="email" name="email" id="email" v-model="user.email" class="input-v" required>
        </div>

        <!-- password -->
        <div class="col-span-12">
          <label for="password" class="text-gray-700 px-1">Password *</label>
          <input type="password" name="password" id="password" v-model="user.password" class="input-v" minlength="6" required>
        </div>

        <!-- confirm password -->
        <div class="col-span-12">
          <label for="password2" class="text-gray-700 px-1">Confirm password *</label>
          <input type="password" name="password2" id="password2" v-model="user.password2" class="input-v" minlength="6" required>
        </div>

         <!-- Delivery Options -->
        {% if settings.HOME_DELIVERY_ENABLED %}
        <div class="col-span-12">
           <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
             <input type="checkbox" id="home_delivery" name="home_delivery" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" v-model="user.profile.home_delivery"/>
             <label for="home_delivery" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer text-gray-700"></label>
           </div>
           <label for="toggle" class="cursor-pointer select-none text-gray-700">Home Delivery</label>
           <small class="block text-gray-400 mt-2">Available in Eugene, Corvallis, and Springfield for a $5 fee. This fee is waived for all orders over $125.</small>
         </div>

         <div class="col-span-12" v-if="user.profile.home_delivery" v-observe-visibility="initAutoCompelete()">
           <label for="address" class="text-gray-700">Address</label>
           <input class="input-v" id="address" type="text" v-model="user.profile.delivery_address" autocomplete="off" required>
        </div>

        <!-- Drop Sites -->
        <div class="col-span-12" v-if="user.profile.home_delivery">
          <label for="drop_site" class="text-gray-700 block">Drop Site Location</label>
          <select name="drop_site" id="drop_site" class="input-v" v-model="user.profile.drop_site" required>
            {% for site in DROPSITE_CHOICES %}
            <option value="{{site.0}}">{{site.1}}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        <!-- invite_code -->
        <div class="col-span-12">
          <label for="invite_code" class="text-gray-700 px-1">Invite Code (Portland dropsites only)</label>
          <input type="text" name="invite_code" id="invite_code" v-model="user.profile.code" class="input-v">
        </div>

        <!-- phone_number -->
        <div class="col-span-6">
          <label for="phone_number" class="text-gray-700 px-1">Contact Number *</label>
          <input type="text" name="phone_number" id="phone_number" v-model="user.profile.phone_number" class="input-v" @input="acceptPhoneNumber" required pattern="[0-9]{3}-[0-9]{3}-[0-9]{4}">
          <small class="text-gray-400">must match format 999-999-9999</small>
        </div>

        <!-- phone_number_2 -->
        <div class="col-span-6">
          <label for="phone_number_2" class="text-gray-700 px-1">Alternate Contact Number</label>
          <input type="text" name="phone_number_2" id="phone_number_2" v-model="user.profile.phone_number_2" class="input-v" @input="acceptPhoneNumber2" pattern="[0-9]{3}-[0-9]{3}-[0-9]{4}">
          <small class="text-gray-400">must match format 999-999-9999</small>
        </div>

        <!-- num_adults -->
        <div class="col-span-6">
          <label for="num_adults" class="text-gray-700 px-1">How many adults are in your family? *</label>
          <input type="number" name="num_adults" id="num_adults" v-model="user.profile.num_adults" class="input-v">
        </div>

        <!-- num_children -->
        <div class="col-span-6">
          <label for="num_children" class="text-gray-700 px-1">How many children are in your family? *</label>
          <input type="number" name="num_children" id="num_children" v-model="user.profile.num_children" class="input-v">
        </div>

        <!-- communication_method -->
        <div class="col-span-6">
          <label for="communication_method" class="text-gray-700 block">What is your preferred method of communication?</label>
          <select name="communication_method" id="communication_method" class="input-v" required>
            <option value="email">Email</option>
            <option value="phone">Phone</option>
            <option value="text">Text</option>
          </select>
        </div>

        <!-- best_time_to_reach -->
        <div class="col-span-6">
          <label for="best_time_to_reach" class="text-gray-700 px-1">What is the best time to reach you? *</label>
          <input type="time" name="best_time_to_reach" id="best_time_to_reach" v-model="user.profile.best_time_to_reach" class="input-v">
        </div>

        <!-- hear_about_us -->
        <div class="col-span-12">
          <label for="hear_about_us" class="text-gray-700 px-1">How did you hear about us? *</label>
          <textarea class="input-v" name="hear_about_us" id="hear_about_us" rows="4"></textarea>
        </div>

        <!-- join_dairy_program -->
        <div class="col-span-12">
          <label class="grid grid-cols-12 gap-1 cursor-pointer">
            <input type="checkbox" class="col-span-1 form-radio h-4 w-4 m-2 text-gray-600" name="join_dairy_program" v-model="user.profile.join_dairy_program">
            <span class="col-span-11 text-gray-700 select-none">Join Dairy Program</span>
          </label>
          <small class="block text-gray-400 pl-6">I would like to join the Dairy program. I understand that I will be charged a $50 herd-share fee when making my first payment and will need to talk to the Dairy Manager before gaining access to dairy products. We'll be in touch soon.</small>
        </div>
        
        <!-- payment_agreement -->
        <div class="col-span-12">
          <label class="grid grid-cols-12 gap-1 cursor-pointer">
            <input type="checkbox" class="col-span-1 form-radio h-4 w-4 m-2 text-gray-600" name="payment_agreement" v-model="user.profile.payment_agreement">
            <span class="col-span-11 text-gray-700 select-none">I agree to make monthly payments in order to maintain my membership with the FFCSA for 6 months, with a minimium of $172 per month.</span>
          </label>
        </div>

        <!-- pickup_agreement -->
        <div class="col-span-12">
          <label class="grid grid-cols-12 gap-1 cursor-pointer">
            <input type="checkbox" class="col-span-1 form-radio h-4 w-4 m-2 text-gray-600" name="pickup_agreement" v-model="user.profile.pickup_agreement">
            <span class="col-span-11 text-gray-700 select-none">I agree to bring my own bags and coolers as needed to pick up my product. The containers that the product arrives in stay at the dropsite. I intend to maintain my membership with the FFCSA for 6 months, with a minimum payment of $172 per month</span>
          </label>
        </div>
      </form>

      <p class="text-base text-gray-700 mb-3"><strong>After signing up, you will receive a welcome email and a Membership Agreement that you will need to sign.</strong></p>
      <p class="text-base text-gray-700 mb-2">Once you have signed the agreement and set up your payments, you will be ready to make your first order!</p>
      <p class="text-base text-gray-700 mb-2">If you do not see these 2 emails after signing up, check your spam folder and let us know if it isn't there.</p>

      <!-- Regiser btn -->
      <div class="flex text-center my-10 pb-20">
        <div class="w-full px-3 mb-5">
          <ff-button text="REGISTER NOW" cls="btn-primary ml-auto mr-3" :loading="personal.loading" v-on:click.native="saveUser"></ff-button>
        </div>
      </div>

    </div>
    <!-- form part -->
  </div>

  {% endif %}
</main>
{% endblock main %}


{% block js %}
<script type="text/javascript" src="https://maps.google.com/maps/api/js?libraries=geometry,places&key={{ settings.GOOGLE_API_KEY }}"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/geocodezip/geoxml3@master/polys/geoxml3.js"></script>
<script>
  const AccountVue = new Vue({
    el: '#signup',
    delimiters: ['((', '))'],
    data: {
      // Personal
      // TODO - might need to update this
      personal: {
        loading: false
      },

      user: {
        first_name: '',
        last_name: '',
        email: '',
        password: '',
        password2: '',
        profile: {
          invite_code: '',
          phone_number: '',
          phone_number_2: '',
          num_adults: '',
          num_children: '',
          communication_method: '',
          best_time_to_reach: '',
          hear_about_us: '',
          home_delivery: false,
          drop_site: 'Farm',
          join_dairy_program: false,
          payment_agreement: false,
          pickup_agreement: false
        }
      },

    },
    methods: {
      // Save user info
      async saveUser() {
        const form = document.getElementById('register-form');
        if (!form.reportValidity()) return



        console.log(this.user)
        console.log(this.user.profile)

        return
        
        try {
          this.personal.loading = true
          const res = await axios.patch(`/api/users/{{user.id}}/`, {...this.user});
          NavVue.show_msg('Updated successfuly')

          this.personal.loading = false
        } catch (error) {
          console.log(error.response.data)
          NavVue.show_msg('Can not save user information', 'error')
          this.personal.loading = false
        }
      },

      acceptPhoneNumber(e) {
        // accept only numbers and format them like 999-999-9999
        const x = this.user.profile.phone_number.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
        this.user.profile.phone_number = !x[2] ? x[1] : x[1] + '-' + x[2] + (x[3] ? '-' + x[3] : '');
      },
      acceptPhoneNumber2(e) {
        // accept only numbers and format them like 999-999-9999
        const x = this.user.profile.phone_number_2.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
        this.user.profile.phone_number_2 = !x[2] ? x[1] : x[1] + '-' + x[2] + (x[3] ? '-' + x[3] : '');
      },
    },
    watch: {},
  })
</script>


<script id="initAddressAutoCompelete">
  function initAutoCompelete() {
    // Init address auto compelete

    // container IS finished rendering to the DOM
    const geoXml = new geoXML3.parser()
    geoXml.parse(static_url + 'docs/delivery_area.kml')

    // default bounds
    const defaultBounds = new google.maps.LatLngBounds(new google.maps.LatLng(44.222193, -123.207548))

    const options = {
      bounds: defaultBounds,
      types: ['address'],
    }

    const addressInput = document.getElementById('address')
    const autocomplete = new google.maps.places.Autocomplete(addressInput, options)
    autocomplete.addListener('place_changed', function () {
      const place = autocomplete.getPlace();
      if (!place) {
        // return error message
      }

      // Set delivery_address value
      AccountVue.user.profile.delivery_address = place.formatted_address

      let success = false

      for (var i = 0; i < geoXml.docs[0].gpolygons.length; i++) {
        if (google.maps.geometry.poly.containsLocation(place.geometry.location, geoXml.docs[0].gpolygons[i])) {
          success = true

          // Check if we are maxed out for the zip code
          zip = null
          place.address_components.forEach(function (c) {
            if (c.types.includes('postal_code')) {
              zip = c.long_name
              return
            }
          })

          $.ajax('/zip-check/' + zip)
          .done(function (data) {
            if (data.is_full) {
              success = false
              NavVue.show_msg('Unfortunately, our delivery route is full and we can not offer home delivery to your zip code at this time. Please check again at a later date as members change drop sites from time-to-time. You can also <a href="mailto:fullfarmcsa@deckfamilyfarm.com">contact us</a> to be notified when a spot opens up!', 'error')
            }
          })
          .fail(function () {
            success = false
            NavVue.show_msg('An error occurred. Please try again later. Please <a href="mailto:fullfarmcsa@deckfamilyfarm.com">contact us</a> if this problem persists.', 'error')
          })
        }
      }
      
      // we don't deliver to this address
      if (!success) {
        NavVue.show_msg('We do not currently offer delivery service to this address. Please <a class="text-blue-500" href="mailto:fullfarmcsa@deckfamilyfarm.com">contact us</a> to be notified when our delivery options expand.', 'error')
      }
    })
  }
</script>
{% endblock %}
