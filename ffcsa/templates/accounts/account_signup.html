{% extends "base.html" %}
{% load staticfiles static %}
{% load i18n mezzanine_tags ffcsa_core_tags %}


{% block main %}
<main id="signup">

  <v-app>
    <v-main class="grey lighten-5">
      <v-container>
        <!-- for logged in users -->
        {% if request.user.is_authenticated %}
        <p>{% trans "You're already logged in. If you'd like to create a new account, you'll need to log out first." %}</p>
        {% else %}
        <div class="max-w-screen-lg grid grid-cols-12 gap-10 mx-auto mt-20 p-3">
          <!-- info part -->
          <div class="col-span-12 md:col-span-5 text-base pt-20">
            <h3 class="mb-5 mt-0 text-brown-7 font-bold text-lg	">Thanks for choosing the Full Farm CSA!</h3>
            <p class="mb-3">
              If you haven't done so already, you can check out our current selection of products <a class="text-primary" target="_blank" href="/products/">here</a>
              and find out more information about our CSA by visiting our <a class="text-primary" target="_blank" href="/faq/">FAQs</a> page.
            </p>
            <p class="mb-3">
              We encourage all CSA members to visit the Deck Family Farm (in Junction City) at least once
              during or before their time in the CSA, so come check us out! Our open gate policy is Monday - Saturday
              during business hours. Let us know when you may be coming and we can arrange a mini tour.
            </p>
            
            <div class="border-b-2 my-8"></div>
            
            <p class="mb-8">
              Our Portland dropsites are currently full. <a class="text-primary" target="_blank" href="https://26403a96.sibforms.com/serve/MUIEAEe-Lhh9Ij9OVpUCDzojW-Mdekxfy3xZjo7tka8o97OAN5FCESzSdtZnYvRkQkahzra5SB0It2X_txOn8Osv64fHf6t3Cv15W_S8yXTczZbBQfQ7Z_voZO4w2Q48UtGXYMgQaelSC0ni3_GivthfTK9FvMchpVPz-q7Y2JscpW2VjQjQSGgfNoJ56dxcF6ASqRwLc5Qkpa2S">Join our waitlist</a> 
              to be notified when a spot opens up. Thank you for understanding and supporting local farms!
            </p>
            
            <!-- commented iframe -->
            {#  <iframe width="540" height="450"#}
            {#  src="https://26403a96.sibforms.com/serve/MUIEAEe-Lhh9Ij9OVpUCDzojW-Mdekxfy3xZjo7tka8o97OAN5FCESzSdtZnYvRkQkahzra5SB0It2X_txOn8Osv64fHf6t3Cv15W_S8yXTczZbBQfQ7Z_voZO4w2Q48UtGXYMgQaelSC0ni3_GivthfTK9FvMchpVPz-q7Y2JscpW2VjQjQSGgfNoJ56dxcF6ASqRwLc5Qkpa2S"#}
            {#  frameborder="0" scrolling="auto" allowfullscreen#}
            {#  style="display: block;margin-left: auto;margin-right: auto;max-width: 100%;"></iframe>#}
            {#  {% errors_for form %}#}
            <!-- commented iframe -->
          </div>
          <!-- info part -->
          
          
          <!-- form part -->
          <div class="col-span-12 md:col-span-7">
            <div class="text-center mb-10">
              <h1 class="font-bold text-3xl text-gray-900">REGISTER</h1>
              <p>Enter your information to register</p>
            </div>
      
            <v-form class="mb-7">
              <v-container>
                <v-row>
                  <!-- first name -->
                  <v-col cols="12" md="6">
                    <v-text-field outlined label="First name *" v-model="user.first_name" required></v-text-field>
                  </v-col>

                  <!-- last name -->
                  <v-col cols="12" md="6">
                    <v-text-field outlined label="Last name *" v-model="user.last_name" required></v-text-field>
                  </v-col>
                  
                  <!-- email -->
                  <v-col cols="12">
                    <v-text-field prepend-inner-icon="mdi-email" outlined label="Email *" v-model="user.email" required></v-text-field>
                  </v-col>

                  <!-- password -->
                  <v-col cols="12" md="6">
                    <v-text-field prepend-inner-icon="mdi-key-variant" outlined label="Password *" v-model="user.password" required></v-text-field>
                  </v-col>

                  <!-- confrim password -->
                  <v-col cols="12" md="6">
                    <v-text-field prepend-inner-icon="mdi-key-variant" outlined label="Confirm password *" v-model="user.password2" required></v-text-field>
                  </v-col>

                  <!-- Delivery Options -->
                  {% if settings.HOME_DELIVERY_ENABLED %}
                  <div>
                    <v-col cols="12">
                      <v-switch
                        v-model="user.profile.home_delivery"
                        inset
                        label="Home Delivery"
                        hint="Available in Eugene, Corvallis, and Springfield for a $5 fee. This fee is waived for all orders over $125."
                        persistent-hint
                      ></v-switch>
                    </v-col>
  
                    <v-col cols="12" v-if="user.profile.home_delivery" v-observe-visibility="initAutoCompelete()">
                      <v-text-field id="address" label="Address" outlined v-model="user.profile.delivery_address" required autocomplete="false"></v-text-field>
                    </v-col>
                  </div>
                  {% endif %}

                  <!-- Drop Sites -->
                  <v-col cols="12">
                    <v-combobox
                        outlined
                        v-if="!user.profile.home_delivery"
                        label="Drop Site Location"
                        v-model="user.profile.drop_site"
                        :items="store.state.drop_sites"
                        item-text="description"
                        item-value="name"
                        :return-object="false"
                      >
                    </v-combobox>
                  </v-col>

                  <!-- invite_code -->
                  <v-col cols="12">
                    <v-text-field outlined label="Invite Code (Portland dropsites only)" v-model="user.profile.code" required></v-text-field>
                  </v-col>

                  <!-- phone_number -->
                  <v-col cols="12" md="6">
                    <v-text-field
                      outlined
                      label="Contact Number *"
                      v-model="user.profile.phone_number"
                      @input="acceptPhoneNumber"
                      hint="must match format 999-999-9999"
                      persistent-hint
                      maxlength=12
                      required>
                    </v-text-field>
                  </v-col>

                  <!-- phone_number_2 -->
                  <v-col cols="12" md="6">
                    <v-text-field
                      outlined
                      label="Alternate Contact Number"
                      v-model="user.profile.phone_number_2"
                      @input="acceptPhoneNumber2"
                      hint="must match format 999-999-9999"
                      persistent-hint
                      maxlength=12
                      required>
                    </v-text-field>
                  </v-col>

                  <!-- num_adults -->
                  <v-col cols="12" md=6>
                    <v-text-field outlined label="How many adults are in your family? *" type="number" v-model="user.profile.num_adults" required></v-text-field>
                  </v-col>

                  <!-- num_children -->
                  <v-col cols="12" md=6>
                    <v-text-field outlined label="How many children are in your family? *" type="number" v-model="user.profile.num_children" required></v-text-field>
                  </v-col>

                  <v-col cols="12">
                    <!-- communication_method -->
                    <v-select
                      :items="communication_methods"
                      item-text="text"
                      item-value="value"
                      :return-object="false"
                      label="What is your preferred method of communication?"
                      outlined
                    ></v-select>

                    <!-- best_time_to_reach -->
                    <v-text-field outlined label="What is the best time to reach you? *" type="time" v-model="user.profile.best_time_to_reach" required></v-text-field>
                    
                    <!-- hear_about_us -->
                    <v-textarea outlined label="How did you hear about us? *" required></v-textarea>

                    <!-- join_dairy_program -->
                    <v-checkbox
                      v-model="user.profile.join_dairy_program"
                      label="Join Dairy Program"
                      hint="I would like to join the Dairy program. I understand that I will be charged a $50 herd-share fee when making my first payment and will need to talk to the Dairy Manager before gaining access to dairy products. We'll be in touch soon."
                      persistent-hint
                    ></v-checkbox>

                    <!-- payment_agreement -->
                    <v-checkbox
                      v-model="user.profile.payment_agreement"
                      label="I agree to make monthly payments in order to maintain my membership with the FFCSA for 6 months, with a minimium of $172 per month."
                      persistent-hint
                    ></v-checkbox>

                    <!-- pickup_agreement -->
                    <v-checkbox
                      v-model="user.profile.pickup_agreement"
                      label="I agree to bring my own bags and coolers as needed to pick up my product. The containers that the product arrives in stay at the dropsite. I intend to maintain my membership with the FFCSA for 6 months, with a minimum payment of $172 per month"
                      persistent-hint
                    ></v-checkbox>
                  </v-col>

                  <v-btn block color="primary" class="font-weight-bold">Sign up</v-btn>
                </v-row>
              </v-container>
            </v-form>
      
            <p class="text-base text-gray-700 mb-3"><strong>After signing up, you will receive a welcome email and a Membership Agreement that you will need to sign.</strong></p>
            <p class="text-base text-gray-700 mb-2">Once you have signed the agreement and set up your payments, you will be ready to make your first order!</p>
            <p class="text-base text-gray-700 mb-2">If you do not see these 2 emails after signing up, check your spam folder and let us know if it isn't there.</p>
      
            <!-- Regiser btn -->
            <div class="flex text-center my-10 pb-20">
              <div class="w-full px-3 mb-5">
                <ff-button text="REGISTER NOW" cls="btn-primary ml-auto mr-3" :loading="personal.loading" v-on:click.native="saveUser"></ff-button>
              </div>
            </div>
      
          </div>
          <!-- form part -->
        </div>
      
        {% endif %}
        
      </v-container>
    </v-main>
  </v-app>

  
</main>
{% endblock main %}


{% block js %}
<script type="text/javascript" src="https://maps.google.com/maps/api/js?libraries=geometry,places&key={{ settings.GOOGLE_API_KEY }}"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/geocodezip/geoxml3@master/polys/geoxml3.js"></script>
<script>
  const AccountVue = new Vue({
    el: '#signup',
    delimiters: ['((', '))'],
    store,
    vuetify: new Vuetify(opts),
    data: {
      // Personal
      // TODO - might need to update this
      personal: {
        loading: false
      },

      communication_methods: [{text: 'Email', value: 'email'}, {text: 'Phone', value: 'phone'}, {text: 'Text', value: 'text'}],

      user: {
        first_name: '',
        last_name: '',
        email: '',
        password: '',
        password2: '',
        profile: {
          invite_code: '',
          phone_number: '',
          phone_number_2: '',
          num_adults: '',
          num_children: '',
          communication_method: '',
          best_time_to_reach: '',
          hear_about_us: '',
          home_delivery: false,
          drop_site: 'Farm',
          join_dairy_program: false,
          payment_agreement: false,
          pickup_agreement: false
        }
      },

    },
    methods: {
      // Save user info
      async saveUser() {
        const form = document.getElementById('register-form');
        if (!form.reportValidity()) return



        console.log(this.user)
        console.log(this.user.profile)

        return
        
        try {
          this.personal.loading = true
          const res = await axios.patch(`/api/users/{{user.id}}/`, {...this.user});
          store.commit('showAlert')

          this.personal.loading = false
        } catch (error) {
          console.log(error.response.data)
          NavVue.show_msg('Can not save user information', 'error')
          this.personal.loading = false
        }
      },

      acceptPhoneNumber(e) {
        // accept only numbers and format them like 999-999-9999
        const x = this.user.profile.phone_number.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
        this.user.profile.phone_number = !x[2] ? x[1] : x[1] + '-' + x[2] + (x[3] ? '-' + x[3] : '');
      },
      acceptPhoneNumber2(e) {
        // accept only numbers and format them like 999-999-9999
        const x = this.user.profile.phone_number_2.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
        this.user.profile.phone_number_2 = !x[2] ? x[1] : x[1] + '-' + x[2] + (x[3] ? '-' + x[3] : '');
      },
    },
    watch: {},
  })
</script>


<script id="initAddressAutoCompelete">
  function initAutoCompelete() {
    // Init address auto compelete

    // container IS finished rendering to the DOM
    const geoXml = new geoXML3.parser()
    geoXml.parse(static_url + 'docs/delivery_area.kml')

    // default bounds
    const defaultBounds = new google.maps.LatLngBounds(new google.maps.LatLng(44.222193, -123.207548))

    const options = {
      bounds: defaultBounds,
      types: ['address'],
    }

    const addressInput = document.getElementById('address')
    const autocomplete = new google.maps.places.Autocomplete(addressInput, options)
    autocomplete.addListener('place_changed', function () {
      const place = autocomplete.getPlace();
      if (!place) {
        // return error message
      }

      // Set delivery_address value
      AccountVue.user.profile.delivery_address = place.formatted_address

      let success = false

      for (var i = 0; i < geoXml.docs[0].gpolygons.length; i++) {
        if (google.maps.geometry.poly.containsLocation(place.geometry.location, geoXml.docs[0].gpolygons[i])) {
          success = true

          // Check if we are maxed out for the zip code
          zip = null
          place.address_components.forEach(function (c) {
            if (c.types.includes('postal_code')) {
              zip = c.long_name
              return
            }
          })

          $.ajax('/zip-check/' + zip)
          .done(function (data) {
            if (data.is_full) {
              success = false
              NavVue.show_msg('Unfortunately, our delivery route is full and we can not offer home delivery to your zip code at this time. Please check again at a later date as members change drop sites from time-to-time. You can also <a href="mailto:fullfarmcsa@deckfamilyfarm.com">contact us</a> to be notified when a spot opens up!', 'error')
            }
          })
          .fail(function () {
            success = false
            NavVue.show_msg('An error occurred. Please try again later. Please <a href="mailto:fullfarmcsa@deckfamilyfarm.com">contact us</a> if this problem persists.', 'error')
          })
        }
      }
      
      // we don't deliver to this address
      if (!success) {
        NavVue.show_msg('We do not currently offer delivery service to this address. Please <a class="text-blue-500" href="mailto:fullfarmcsa@deckfamilyfarm.com">contact us</a> to be notified when our delivery options expand.', 'error')
      }
    })
  }
</script>
{% endblock %}
