<!doctype html>
<html lang="{{ LANGUAGE_CODE }}"{% if LANGUAGE_BIDI %} dir="rtl"{% endif %}>
  {% load pages_tags mezzanine_tags i18n staticfiles static %}
  {% load render_bundle from webpack_loader %}

  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="keywords" content="{% block meta_keywords %}{% endblock %}">
    <meta name="description" content="{% block meta_description %}{% endblock %}">
    
    <title>{% block meta_title %}{% endblock %} | {% if settings.SITE_TITLE %}{{ settings.SITE_TITLE }}{% endif %}</title>
    
    {# Generated by https://realfavicongenerator.net/ #}
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'img/favicon/apple-touch-icon.png' %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'img/favicon/favicon-32x32.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'img/favicon/favicon-16x16.png' %}">
    <link rel="manifest" href="{% static 'img/favicon/site.webmanifest' %}">
    <link rel="mask-icon" href="{% static 'img/favicon/safari-pinned-tab.svg' %}" color="#000000">
    <link rel="shortcut icon" href="{% static 'img/favicon/favicon.ico' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" />
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="{% static 'img/favicon/browserconfig.xml' %}">
    <meta name="theme-color" content="#ffffff">
    {# End favicon config #}

    {% include 'ffcsa_core/includes/rollbar.html' %}

    {% ifinstalled mezzanine.blog %}
      <link rel="alternate" type="application/rss+xml" title="RSS" href="{% url 'blog_post_feed' 'rss' %}">
      <link rel="alternate" type="application/atom+xml" title="Atom" href="{% url 'blog_post_feed' 'atom' %}">
    {% endifinstalled %}

    <!-- vuetify -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">

    <!-- to add custom css inside the html pages -->
    {% compress css %}
      <!-- Global CSS -->
      <style>
        /* global css */
        :root {
          --products-banner-bg: url({% static 'img/cows-banner-2.jpg' %});
          --products-aboutus-bg: url({% static 'img/contact-us.jpg' %});
          --hayden: url({% static 'img/hayden.jpg' %});
          --preston: url({% static 'img/preston.jpg' %});
          --group: url({% static 'img/group.jpg' %});
        }

        .v-navigation-drawer {
          z-index: 999999 !important;
        }

        .v-navigation-drawer.cart-drawer {
          z-index: 9999999 !important;
        }

        .v-application--wrap {
          min-height: auto !important;
        }

        .v-overlay__scrim {
          height: 100vh !important;
        }

        .v-application {
          font-family: 'Helvetica', Arial, "Lucida Grande", sans-serif;
        }

        .menu-triangle {
          /* margin-top: 40px; */
          contain: initial;
          overflow: visible;
        }

        .menu-triangle::before {
          position: absolute;
          content: url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 16 16' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12.9094 10.2281L12.8531 10.1625L8.60313 5.27188C8.45938 5.10625 8.24375 5.00313 8.00313 5.00313C7.7625 5.00313 7.54688 5.10938 7.40313 5.27188L3.15625 10.1531L3.08438 10.2344C3.03125 10.3125 3 10.4062 3 10.5062C3 10.7781 3.23125 11 3.51875 11L12.4813 11C12.7688 11 13 10.7781 13 10.5062C13 10.4031 12.9656 10.3063 12.9094 10.2281Z' fill='white'/%3E%3C/svg%3E%0A");
          top: -1rem;
          left: 10%;
          width: 10px; 
          height: 13px; 
        }

        .alert-fixed {
          position: fixed;
          top: 5rem;
          right: 1rem;
          z-index: 9999999;
        }
      </style>

      <!-- Custom CSS per page -->
      {% block css %}{% endblock %}
    {% endcompress %}

    <!-- •• removed below line •• -->
    <!-- render_bundle "manifest" "css"  -->
    {% render_bundle "main"  %}

    
    <noscript>
      <img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=205901347148225&ev=PageView&noscript=1"/>
    </noscript>

    {% block extra_head %}{% endblock %}
  </head>

  <body id="{% block body_id %}body{% endblock %}" class="{% block body_class %}{% endblock %}">

    <div id="app" v-cloak>
      <v-app>
        <!-- alert compoent -->
        <v-alert border="left" transition="slide-y-transition" :type="$store.state.alert.type" :value="$store.state.alert.value" dense width=300 class="alert-fixed">(($store.state.alert.content))</v-alert>
  
        <!-- Side Cart -->
        <v-navigation-drawer class="cart-drawer" v-model="drawer" width=456 right fixed temporary>
          <!-- header and close button -->
          <v-toolbar elevation="1">
            <v-row>
              <v-col cols="2"></v-col>
              <v-col class="d-flex justify-space-around">
                <v-toolbar-title class="pt-2">Your Cart ( ((store.state.cart.items.length)) )</v-toolbar-title>
              </v-col>
              <v-col cols="2" class="d-flex justify-end">
                <v-btn icon plain @click="drawer = !drawer" >
                  <v-icon color="gray lighten-2">mdi-close</v-icon>
                </v-btn>
              </v-col>
            </v-row>
          </v-toolbar>
          <!-- header and close button -->

          <!-- content -->
          <section class="cart-items pl-3 pr-0 mt-5 mt-5 overflow-y-scroll" style="max-height: 70vh;">
            <template v-if="store.state.cart.items.length > 0" v-for="item in store.state.cart.items">
              <div class="grid grid-cols-3 gap-4 border-b-2 border-black border-opacity-10 mb-4 pb-4">
                <!-- item image -->
                <div class="col-span-1">
                  <div class="block h-auto w-full mb-2" :style="'background-image: url(/media/' + item.image + ');background-position: center; background-repeat: no-repeat; background-size: cover;width: 100%;height: 6rem;'"></div>
                </div>
                <!-- item image -->
      
                <!-- item control -->
                <div class="col-span-2 pr-2">
                  <div class="flex">
                    <h4 class="subtitle-1 font-weight-bold capitalize">((item.description))</h4>
                    <v-spacer></v-spacer>
                    <v-btn text icon color="red lighten-2" @click.prevent="removeCartItem(item)">
                      <v-icon small color="gray lighten-2">mdi-close</v-icon>
                    </v-btn>
                  </div>
      
                  <div class="flex mt-10">
                    <p>$((item.unit_price))</p>
      
                    <div class="ml-auto">
                      <div class="flex">
                        <v-btn small fab elevation="2" @click="decreaseItemQuantity(item, $event)">
                          <v-icon color="accent">mdi-minus</v-icon>
                        </v-btn>
                        
                        <p class="px-4 pt-1 select-none">((item.quantity))</p>

                        <v-btn small fab elevation="2" @click="increaseItemQuantity(item, $event)" :disabled="item.all_quantity_in_cart">
                          <v-icon color="accent">mdi-plus</v-icon>
                        </v-btn>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- item control -->
              </div>
            </template>

            <template v-else>
              <p class="opacity-50 text-center mt-10 font-thin">No items in cart</p>
            </template>

          </section>
          <!-- content -->

          <!-- total and checkout -->
          <section class="bg-white absolute px-3 pt-4 mt-10 inset-x-0 bottom-5 border border-top">
            <div class="flex text-black font-bold">
              <p class="mb-2">SUBTOTAL</p>
              <p class="mb-2 ml-auto">$((store.state.cart.total_price))</p>
            </div>

            {% if user.is_authenticated %}
            <div class="flex text-black font-bold">
              <p class="mb-2">DELIVERY FEE</p>
              <p class="mb-2 ml-auto">$((store.state.cart.delivery_fee))</p>
            </div>
            <div class="flex text-black font-bold">
              <p>REMAINING BUDGET</p>
              <p class="ml-auto">$((store.state.cart.remaining_budget))</p>
            </div>
            {% endif %}
            
            <v-btn large block color="primary" class="font-weight-bold mt-4" href="/cart" :disabled="!store.state.cart.items.length">CONTINUE TO CHECKOUT</v-btn>
          </section>
          <!-- total and checkout -->

        </v-navigation-drawer>

        <!-- Menu drawer -->
        <v-navigation-drawer  v-model="menu" width='100%' right fixed temporary class="opacity-95">
          <v-btn class="ma-2" absolute top right icon plain @click="menu = !menu" class="ml-auto mt-1 mr-5" >
            <v-icon x-large color="gray lighten-2">mdi-close</v-icon>
          </v-btn>

          <v-container fill-height fluid>
            <v-row align="center" justify="center">
              <v-col cols=12 class="text-center">
                <v-btn plain class="font-weight-bold" href="/">Home</v-btn>
              </v-col>
              <v-col cols=12 class="text-center">
                <v-btn plain class="font-weight-bold" href="/csa/">Full Farm CSA</v-btn>
              </v-col>
              <v-col cols=12 class="text-center">
                <v-btn plain class="font-weight-bold" href="/products/">Shop</v-btn>
              </v-col>
              <v-col cols=12 class="text-center">
                <v-btn plain class="font-weight-bold" href="/about/">About</v-btn>
              </v-col>
              <v-col cols=12 class="text-center">
                <v-btn plain class="font-weight-bold" href="/faq/">FAQ</v-btn>
              </v-col>
              <v-col cols=12 class="text-center">
                <v-btn class="ma-2" text icon @click="drawer = !drawer">
                  <v-badge :content="store.state.cart.items.length" :value="store.state.cart.items.length" color="primary" overlap @click="drawer = !drawer">
                    <v-icon large>mdi-cart-outline</v-icon>
                  </v-badge>
                </v-btn>
              </v-col>
            </v-row>
          </v-container>
        </v-navigation-drawer>
        
        <!-- Navbar -->
        <v-app-bar absolute app>
          
          <!-- Logo -->
          <v-toolbar-title class="mr-5">
            <a href="/" ><img class="h-12" src="/static/img/dff-logo-long.png" alt="logo"></a>
          </v-toolbar-title>

          <!-- NavLinks -->
          <div class="d-none d-md-block">
            <v-btn plain class="text-capitalize font-weight-bold" href="/csa/">Full Farm CSA</v-btn>
            <v-menu offset-y open-on-hover transition="slide-y-transition" bottom close-delay=120 nudge-bottom=5 content-class="menu-triangle" >
              <template v-slot:activator="{ on, attrs }">
                <v-btn plain v-bind="attrs" v-on="on" text href="/products/">
                  <span class="mx-2 text-capitalize font-weight-bold">Shop</span>
                </v-btn>
              </template>
  
              <v-card>
                <v-row >
                  <v-col>
                    <v-list class="rounded">
                      <v-list-item-group color="primary">
                        <v-list-item href="/products/?selectedCategory=Pasture Raised Meats">
                          <v-list-item-title>PASTURE RAISED MEATS</v-list-item-title>
                        </v-list-item>
                        <v-list-item href="/products/?selectedCategory=ORGANIC VEGETABLES">
                          <v-list-item-title>ORGANIC VEGETABLES</v-list-item-title>
                        </v-list-item>
                        <v-list-item href="/products/?selectedCategory=RAW DAIRY">
                          <v-list-item-title>RAW DAIRY</v-list-item-title>
                        </v-list-item>
                        <v-list-item href="/products/?selectedCategory=ORGANIC FRUIT">
                          <v-list-item-title>ORGANIC FRUIT</v-list-item-title>
                        </v-list-item>
                      </v-list-item-group>
                    </v-list>
                  </v-col>
  
                  <v-col>
                    <v-list class="rounded">
                      <v-list-item-group color="primary">
                        <v-list-item href="/products/?selectedCategory=PANTRY">
                          <v-list-item-title>PANTRY</v-list-item-title>
                        </v-list-item>
                        <v-list-item>
                          <v-list-item-title>RECIPIES</v-list-item-title>
                        </v-list-item>
                      </v-list-item-group>
                    </v-list>
                  </v-col>
                </v-row>
              </v-card>
            </v-menu>
            <v-btn plain class="text-capitalize font-weight-bold" href="/about/">About</v-btn>
            <v-btn plain class="text-capitalize font-weight-bold" href="/faq/">FAQ</v-btn>
          </div>

          <v-spacer></v-spacer>

          {% if user.is_authenticated %}
          <!-- User drop down menu -->
            <v-menu offset-y open-on-hover transition="slide-y-transition" bottom close-delay=120 nudge-bottom=5 content-class="menu-triangle">
              <template v-slot:activator="{ on, attrs }">
                <v-btn v-bind="attrs" v-on="on" text>
                  <v-icon>mdi-account-outline</v-icon>
                  <span class="mx-2 text-capitalize font-weight-bold">{{user.first_name}}</span>
                  <v-icon>mdi-chevron-down</v-icon>
                </v-btn>
              </template>

              <v-list class="rounded">
                <v-list-item-group color="primary">
                  <v-list-item v-for="(item, index) in items" :key="index" :href="item.href">
                    <v-list-item-title>(( item.title ))</v-list-item-title>
                  </v-list-item>
                </v-list-item-group>
              </v-list>
            </v-menu>
          {% else %}
          <!-- Login and Sing up -->
            <div>
              <v-btn color="primary" href="{% url 'signup' %}{% if not 'account' in request.path %}?next={{ request.path }}{% else %}?next=/{% endif %}" class="mx-1 font-weight-bold">
                BECOME A MEMBER
              </v-btn>
  
              <v-btn text href="{% url 'login' %}{% if not 'account' in request.path %}?next={{ request.path }}{% else %}?next=/{% endif %}" class="mx-1 font-weight-bold">
                LOGIN
              </v-btn>
            </div>
          {% endif %}

          <!-- Cart Icon -->
          <v-btn class="d-none d-md-block ma-2" text icon @click="drawer = !drawer">
            <v-badge :content="store.state.cart.items.length" :value="store.state.cart.items.length" color="primary" overlap @click="drawer = !drawer">
              <v-icon large>mdi-cart-outline</v-icon>
            </v-badge>
          </v-btn>

          <!-- Menu Icon (Small Screen) -->
          <v-btn class="d-md-none ma-2" text icon @click="menu = !menu">
            <v-icon large>mdi-menu</v-icon>
          </v-btn>

        </v-app-bar>

        <!-- Sizes your content based upon application components -->
        <v-main></v-main>

      </v-app>
    </div>


    
    <!-- main content -->
    <div id="wrapper" class="hiddens">

      <div style="min-height: 80vh;">
      {% block all_content %}
        {% nevercache %}
          {% if messages %}
          <!-- <div class="messages">
            {% for message in messages %}
              <div class="alert alert-dismissable alert-{{ message.tags }}" data-alert="alert">
                <button type="button" class="close" data-dismiss="alert"aria-hidden="true">&times;</button>
                {{ message }}
              </div>
            {% endfor %}
          </div> -->
          {% endif %}
        {% endnevercache %}
        
        {% block topbar %}{% endblock %}

        {% block main_wrapper %}
          {% block main %}{% endblock %}
        {% endblock %}
      {% endblock %}
      </div>

      <!-- Footer -->
      {% if 'accounts' not in request.path %}
      {% include 'partials/footer.html' %}
      {% endif %}

    </div>

    
    {% compress js %}    
    <!-- Facebook Pixel Code -->
    <script>
      !function(f,b,e,v,n,t,s)
      {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
      fbq('init', '205901347148225');
      fbq('track', 'PageView');
    </script>
    <!-- End Facebook Pixel Code -->

    <!-- Load the JS from bundle -->
    {% render_bundle "main" "js" %}

    <!-- Load scripts -->
    <script src="{% static 'mezzanine/js/'|add:settings.JQUERY_FILENAME %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14"></script>
    <script src="https://unpkg.com/vuex@3.6.2/dist/vuex.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <!-- Global Config & Variables -->
    <script>
      // Axios config
      axios.defaults.headers = {'X-CSRFToken': '{{csrf_token}}'}

      const static_url = "{% get_static_prefix %}";
      const media_url = "{% get_media_prefix %}";
    </script>

    <!-- Vue Main App Setup -->
    <script>
      // Vuex Store
      const store = new Vuex.Store({
        state: {
          count: 200,
          cart: {
            shown: false,
            items: [],
            total_price: 0,
            delivery_fee: 0,
            remaining_budget: 0,
            attending_dinner: 0
          },
          drop_sites: [],
          alert: {
            type: 'success',
            value: false,
            content: 'Updated now!'
          }
        },
        mutations: {
          increment (state) {
            state.count++
          },
          showAlert(state, val={type: 'success', content: 'Updated successfuly'}) {
            this.state.alert = {...this.state.alert, ...val}
            this.state.alert.value = true;
          }
        }
      })

      // Vuetify options
      const opts = {
        theme: {
          themes: {
            light: {
              primary: '#e16231',
              secondary: '#b0bec5',
              accent: '#914323',
              error: '#b71c1c',
            },
          },
        },
      }
  
      // Vue App
      const App = new Vue({
        el: '#app',
        delimiters: ['((', '))'],
        store,
        vuetify: new Vuetify(opts),
        data() {
          return {
            drawer: false,
            menu: false,
            counter: 0,

            items: [
              { title: 'Account settings', href: '/accounts/update/'},
              { title: 'Support', href: '#'},
              { title: 'My orders', href: '#'},
              { title: 'Logout', href: `{% url 'logout' %}?next={{ request.get_full_path }}`},
            ],

            showNavDropdown: false,
            showUserDropdown: false,
          }
        },
        methods: {
          async fetchCart() {
            try {
              const res = await axios.get('/api/cart/');
              const { id, items, total_price, delivery_fee, remaining_budget, attending_dinner } = res.data
              console.log(res.data)
              store.state.cart.items = items;
              store.state.cart.total_price = total_price;
              store.state.cart.delivery_fee = delivery_fee;
              store.state.cart.remaining_budget = remaining_budget;
              store.state.cart.attending_dinner = attending_dinner;
            } catch (error) {
              console.log('Can not fetch Cart')
            }
          },
          async addToCart(variation) {
            // Add item to session cart
            const res = await axios.post(`/api/product_variations/${variation.id}/add_to_cart/`)

            ProductsVue.hideProductModal();
            this.drawer = !this.drawer;
            this.fetchCart();
          },
          async removeCartItem(item) {
            // remove an item from cart
            const res = await axios.post(`/api/cart/${item.id}/remove_item/`);
            this.fetchCart()
          },
          async clearCart() {
            // remove all items from cart and rest attending_dinner to 0
            const res = await axios.post('/api/cart/clear/');
            this.fetchCart()
          },
        
          // per item
          async increaseItemQuantity(item, event) {
            // increase CartItem quantity
            const controlContainer = event.target.parentElement
            // disable buttons
            controlContainer.querySelectorAll('button').forEach(btn => btn.disabled = true);
            
            try {
              const res = await axios.post(`/api/cart/${item.id}/increase_item/`);
              this.fetchCart();
              // enable buttons
              controlContainer.querySelectorAll('button').forEach(btn => btn.disabled = false);
            } catch (error) {
              console.log(error)
              // enable buttons
              controlContainer.querySelectorAll('button').forEach(btn => btn.disabled = false);
            }
          },
          async decreaseItemQuantity(item, event) {
            // increase CartItem quantity
            const controlContainer = event.target.parentElement
            // disable buttons
            controlContainer.querySelectorAll('button').forEach(btn => btn.disabled = true);
            
            try {
              const res = await axios.post(`/api/cart/${item.id}/decrease_item/`);
              this.fetchCart();
              // enable buttons
              controlContainer.querySelectorAll('button').forEach(btn => btn.disabled = false);
            } catch (error) {
              console.log(error)
              // enable buttons
              controlContainer.querySelectorAll('button').forEach(btn => btn.disabled = false);
            }
          },
          
          // get drop sites
          async getDropSites() {
            try {
              const res = await axios.post(`/api/resources/get_drop_sites/`);
              store.state.drop_sites = res.data.sites
            } catch (error) {
              console.log(error.response.data)
              store.commit('showAlert', {type: 'error', content: error.response.data.detail})
            }
          },

          hide_alert: function (event) {
            // console.log('Hide')
            // `event` is the native DOM event
            window.setInterval(() => {
              store.state.alert.value = false;
              // console.log("hide alert after 3 seconds");
            }, 3000)    
          }
        },
        watch: {
          '$store.state.alert.value': function(val) {
            if (val) {
              setTimeout(() => {
                // if (this.notification.text.length < 65) this.notification.shown = false
                this.hide_alert();
              }, 3000);
            }
          }
        },
        computed: {},
        async mounted() {
          // get the cart using user session
          this.fetchCart()
          this.getDropSites()

          // hide alert
          // if(alert){
          //   this.hide_alert();
          // }
        }

      })
    </script>

    <script defer>
      // close side-cart if open
      document.addEventListener('keyup', e => {
        if (e.key === "Escape") {
          App.drawer = false;
        }
      })
    </script>

    <!-- Custom JS per page -->
    {% block js %}{% endblock %}
    {% endcompress %}
  </body>
</html>
