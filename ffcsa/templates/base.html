<!doctype html>
<html lang="{{ LANGUAGE_CODE }}"{% if LANGUAGE_BIDI %} dir="rtl"{% endif %}>
  {% load pages_tags mezzanine_tags i18n staticfiles static %}
  {% load render_bundle from webpack_loader %}

  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="keywords" content="{% block meta_keywords %}{% endblock %}">
    <meta name="description" content="{% block meta_description %}{% endblock %}">
    
    <title>{% block meta_title %}{% endblock %} | {% if settings.SITE_TITLE %}{{ settings.SITE_TITLE }}{% endif %}</title>
    
    {# Generated by https://realfavicongenerator.net/ #}
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'img/favicon/apple-touch-icon.png' %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'img/favicon/favicon-32x32.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'img/favicon/favicon-16x16.png' %}">
    <link rel="manifest" href="{% static 'img/favicon/site.webmanifest' %}">
    <link rel="mask-icon" href="{% static 'img/favicon/safari-pinned-tab.svg' %}" color="#000000">
    <link rel="shortcut icon" href="{% static 'img/favicon/favicon.ico' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" />
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="{% static 'img/favicon/browserconfig.xml' %}">
    <meta name="theme-color" content="#ffffff">
    {# End favicon config #}

    {% include 'ffcsa_core/includes/rollbar.html' %}

    {% ifinstalled mezzanine.blog %}
      <link rel="alternate" type="application/rss+xml" title="RSS" href="{% url 'blog_post_feed' 'rss' %}">
      <link rel="alternate" type="application/atom+xml" title="Atom" href="{% url 'blog_post_feed' 'atom' %}">
    {% endifinstalled %}

    {% compress css %}
      {% block extra_css %}{% endblock %}
    {% endcompress %}

    <style>
      /* global css */
      :root {
        --products-banner-bg: url({% static 'img/cows-banner-2.jpg' %});
      }

      .centered { 
        position: fixed;
        top: 50%;
        left: 50%;
        margin-top: '-[1/2(element-height)]';
        margin-left: '-[1/2(element-width)]';
      }
    </style>

    <!-- •• removed below line •• -->
    <!-- render_bundle "manifest" "css"  -->
    {% render_bundle "style" "css" %}

    <!-- to add custom css inside the html pages -->
    {% block custom_css %}{% endblock %}

    {% compress js %}
      <script src="{% static 'mezzanine/js/'|add:settings.JQUERY_FILENAME %}"></script>
      {% block extra_js %}{% endblock %}
    {% endcompress %}
    
    <!-- Facebook Pixel Code -->
    <script>
      !function(f,b,e,v,n,t,s)
      {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
      fbq('init', '205901347148225');
      fbq('track', 'PageView');
    </script>
    
    <noscript>
      <img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=205901347148225&ev=PageView&noscript=1"/>
    </noscript>
    <!-- End Facebook Pixel Code -->

    <!--[if lt IE 9]>
    <script src="{% static "js/html5shiv.js" %}"></script>
    <script src="{% static "js/respond.min.js" %}"></script>
    <![endif]-->

    {% compress js %}
        <script>
            /* Accessibility. Emulate click event in place of enter for focusable divs. This allows 'onclick' to handle enter presses. */
            window._previous_tab_element = null;

            document.addEventListener('keyup', (event) => {
                if (event.keyCode === 13 && event.target.tagName.toLowerCase() === 'div') {
                    event.preventDefault();
                    event.target.click();

                // Make sure outline is shown on tab
                } else if (event.keyCode === 9) {
                    if (window._previous_tab_element != null) {
                        window._previous_tab_element.classList.remove('tab-navigation-outline');
                    }

                    event.target.classList.remove('outline-none');
                    event.target.classList.add('tab-navigation-outline');
                    window._previous_tab_element = event.target;

                } else {
                    return false;
                }
            });
        </script>
    {% endcompress %}

    {% block extra_head %}{% endblock %}
  </head>

  <body id="{% block body_id %}body{% endblock %}" class="{% block body_class %}{% endblock %}">

    <!-- main spinner -->
    <section id="main-spinner" class="centered">
      <img src="{% static 'gifs/spinner.gif' %}" alt="spinner">
    </section>

    
    <!-- main content -->
    <div id="wrapper" class="hidden">
      <header">
        <nav id="navVue" class="px-4 py-5 lg:px-10 lg:py-3 bg-white select-none h-auto" v-cloak>
          <div class="flex items-center">
            <a href="/" id="header-home-icon" class="inline-block no-select-background w-3/5 lg:w-2/5" role="button" tabindex="0" aria-label="Home">
              <img class="h-12" src="/static/img/dff-logo-long.png" draggable="false" aria-hidden="true">
            </a>
  
            <!-- Desktop menu -->
            <section class="ml-auto hidden md:flex items-center">
              {% if user.is_authenticated %}
              <div id="userDropdown" class="relative inline-block text-left mr-3">
                <div>
                  <button id="username" @click="showUserDropdown = !showUserDropdown" type="button" class="capitalize rounded-md px-4 py-2 bg-white text-lg font-medium text-gray-700 hover:bg-gray-50 hover:text-orange focus:outline-none focus:text-orange" id="options-menu" aria-haspopup="true" aria-expanded="true">
                    <!-- user icon -->
                    <i class="far fa-user mr-3 mt-1"></i>
                    {{user}}
                    <!-- arrow down -->
                    <i class="fas fa-angle-down ml-2 h-5 w-5 pt-1"></i>
                  </button>
                </div>
                
                <div :class="[(showUserDropdown ? '' : 'hidden'), 'origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5']">
                  <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
                    <a href="/accounts/update/" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900" role="menuitem">Account settings</a>
                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900" role="menuitem">Support</a>
                    <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900" role="menuitem">My orders</a>
                    <a href="{% url 'logout' %}?next={{ request.get_full_path }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900" role="menuitem">Logout</a>
                  </div>
                </div>
              </div>
              {% else %}
              <!-- become a member -->
              <a href="{% url 'signup' %}{% if not 'account' in request.path %}?next={{ request.path }}{% else %}?next=/{% endif %}"
                class="btn btn-primary mr-4">
                BECOME A MEMBER</a>
              <!-- login -->
              <a href="{% url 'login' %}{% if not 'account' in request.path %}?next={{ request.path }}{% else %}?next=/{% endif %}"
                class="text-sm font-bold tracking-wide hover:text-primary mr-4">LOGIN</a>
              {% endif %}
  
              <!-- Cart icon -->
              <div class="cart">
                <a href="#" @click.prevent="cart.shown = true">
                  <div class="relative">
                    <svg width="30" height="30" viewBox="0 0 56 56" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M54.8973 14.2968C53.6821 16.856 48.3397 29.204 47.6117 30.3464C47.5277 30.4808 47.4493 30.6152 47.3765 30.744C46.6653 31.9592 45.9149 32.8944 43.3277 32.8944H18.6373C19.1525 34.468 20.2333 36.4056 22.4733 36.4056H43.8429C44.4757 36.4056 44.9853 36.9208 44.9853 37.548C44.9853 38.1808 44.4757 38.6904 43.8429 38.6904H22.4733C19.3037 38.6904 16.9853 36.2096 16.1229 32.4016C15.6469 30.3016 9.86215 10.948 9.44775 9.43044C9.00535 8.46724 7.96935 7.77284 6.96695 7.77284H1.70295C1.07015 7.77284 0.560547 7.25764 0.560547 6.63044C0.560547 6.00324 1.07575 5.48804 1.70295 5.48804H6.96695C8.92695 5.48804 10.7805 5.59444 11.5813 7.45364C11.6037 7.50404 11.6205 7.55444 11.6317 7.60484C11.8613 8.43364 16.6549 25.4408 18.0213 30.604H43.3221C44.8061 30.604 44.9517 30.3464 45.3941 29.5904C45.4837 29.4392 45.5733 29.2824 45.6797 29.12C46.3573 28.056 51.6661 15.7808 52.7973 13.3952C53.2677 12.1632 53.1837 11.4912 53.0549 11.3008C52.9709 11.1776 52.6965 11.1048 52.3213 11.1048C49.8461 11.144 18.4189 11.1048 17.3269 11.1048C16.6941 11.1048 16.1845 10.5896 16.1845 9.95684C16.1845 9.32404 16.6941 8.81444 17.3269 8.81444C17.5957 8.81444 49.8237 8.85364 52.2989 8.81444C53.8053 8.81444 54.5613 9.45844 54.9365 10.0016C55.6197 10.9984 55.6085 12.4432 54.8973 14.2968ZM21.8629 39.8216C24.8085 39.8216 27.2109 42.2184 27.2109 45.1696C27.2109 48.1208 24.8141 50.512 21.8629 50.512C18.9173 50.512 16.5205 48.1152 16.5205 45.164C16.5205 42.2128 18.9173 39.8216 21.8629 39.8216ZM21.8629 48.3168C23.5989 48.3168 25.0101 46.9056 25.0101 45.1696C25.0101 43.4336 23.5989 42.0224 21.8629 42.0224C20.1269 42.0224 18.7157 43.4336 18.7157 45.1696C18.7213 46.9056 20.1325 48.3168 21.8629 48.3168Z" fill="black"/>
                      <path d="M43.608 39.8218C46.5536 39.8218 48.956 42.2186 48.956 45.1698C48.956 48.121 46.5592 50.5122 43.608 50.5122C40.6568 50.5122 38.2656 48.1154 38.2656 45.1642C38.2656 42.213 40.6624 39.8218 43.608 39.8218ZM43.608 48.317C45.344 48.317 46.7552 46.9058 46.7552 45.1698C46.7552 43.4338 45.344 42.0226 43.608 42.0226C41.872 42.0226 40.4608 43.4338 40.4608 45.1698C40.4608 46.9058 41.8776 48.317 43.608 48.317Z" fill="black"/>
                    </svg>
    
                    <span class="text-xs text-white text-center bg-red-2 rounded-full absolute" style="top: -.5rem;right: -.6rem;width: 1rem;">
                      ((cart.items.length))
                    </span>
                  </div>
                </a>
              </div>
              <!-- Cart icon -->
            </section>

            <div class="ml-auto md:hidden">
              <i @click="showNavDropdown = !showNavDropdown" class="fas text-4xl fa-bars text-secondary self-center" role="button"></i>
            </div>
          </div>

          <!-- Notification -->
          <section v-show="notification.shown" class="notification">
            <div 
            :class="[notification.typeClass, 'fixed z-50 top-20 right-4 rounded bg-white shadow-lg p-4 border-l-4 border-green w-96 max-w-lg']">
            <i class="fas fa-times absolute right-5 opacity-70 hover:opacity-100 cursor-pointer" @click="notification.shown = false"></i>
              <p class="mt-2 w-11/12" v-html="notification.text"></p>
            </div>
          </section>

          <!-- Mobile menu -->
          <div :class="[(showNavDropdown ? '' : 'hidden'), 'mt-5']">
            <ul class="text-center text-secondary font-bold">


              <li><a href="{% url 'signup' %}{% if not 'account' in request.path %}?next={{ request.path }}{% else %}?next=/{% endif %}" class="hover:text-primary">BECOME A MEMBER</a></li>
              <li><a href="{% url 'signup' %}{% if not 'account' in request.path %}?next={{ request.path }}{% else %}?next=/{% endif %}" class="hover:text-primary">MEMBER SIGN IN</a></li>
              <li>
                <a href="#" @click.prevent="cart.shown = true" class="hover:text-primary">
                  <div class="relative">
                    <svg class="mx-auto" width="30" height="30" viewBox="0 0 56 56" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M54.8973 14.2968C53.6821 16.856 48.3397 29.204 47.6117 30.3464C47.5277 30.4808 47.4493 30.6152 47.3765 30.744C46.6653 31.9592 45.9149 32.8944 43.3277 32.8944H18.6373C19.1525 34.468 20.2333 36.4056 22.4733 36.4056H43.8429C44.4757 36.4056 44.9853 36.9208 44.9853 37.548C44.9853 38.1808 44.4757 38.6904 43.8429 38.6904H22.4733C19.3037 38.6904 16.9853 36.2096 16.1229 32.4016C15.6469 30.3016 9.86215 10.948 9.44775 9.43044C9.00535 8.46724 7.96935 7.77284 6.96695 7.77284H1.70295C1.07015 7.77284 0.560547 7.25764 0.560547 6.63044C0.560547 6.00324 1.07575 5.48804 1.70295 5.48804H6.96695C8.92695 5.48804 10.7805 5.59444 11.5813 7.45364C11.6037 7.50404 11.6205 7.55444 11.6317 7.60484C11.8613 8.43364 16.6549 25.4408 18.0213 30.604H43.3221C44.8061 30.604 44.9517 30.3464 45.3941 29.5904C45.4837 29.4392 45.5733 29.2824 45.6797 29.12C46.3573 28.056 51.6661 15.7808 52.7973 13.3952C53.2677 12.1632 53.1837 11.4912 53.0549 11.3008C52.9709 11.1776 52.6965 11.1048 52.3213 11.1048C49.8461 11.144 18.4189 11.1048 17.3269 11.1048C16.6941 11.1048 16.1845 10.5896 16.1845 9.95684C16.1845 9.32404 16.6941 8.81444 17.3269 8.81444C17.5957 8.81444 49.8237 8.85364 52.2989 8.81444C53.8053 8.81444 54.5613 9.45844 54.9365 10.0016C55.6197 10.9984 55.6085 12.4432 54.8973 14.2968ZM21.8629 39.8216C24.8085 39.8216 27.2109 42.2184 27.2109 45.1696C27.2109 48.1208 24.8141 50.512 21.8629 50.512C18.9173 50.512 16.5205 48.1152 16.5205 45.164C16.5205 42.2128 18.9173 39.8216 21.8629 39.8216ZM21.8629 48.3168C23.5989 48.3168 25.0101 46.9056 25.0101 45.1696C25.0101 43.4336 23.5989 42.0224 21.8629 42.0224C20.1269 42.0224 18.7157 43.4336 18.7157 45.1696C18.7213 46.9056 20.1325 48.3168 21.8629 48.3168Z" fill="black"/>
                      <path d="M43.608 39.8218C46.5536 39.8218 48.956 42.2186 48.956 45.1698C48.956 48.121 46.5592 50.5122 43.608 50.5122C40.6568 50.5122 38.2656 48.1154 38.2656 45.1642C38.2656 42.213 40.6624 39.8218 43.608 39.8218ZM43.608 48.317C45.344 48.317 46.7552 46.9058 46.7552 45.1698C46.7552 43.4338 45.344 42.0226 43.608 42.0226C41.872 42.0226 40.4608 43.4338 40.4608 45.1698C40.4608 46.9058 41.8776 48.317 43.608 48.317Z" fill="black"/>
                    </svg>
    
                    <span class="text-xs text-white text-center bg-red-2 rounded-full absolute" style="top: -.5rem;right: -.6rem;width: 1rem;">
                      ((cart.items.length))
                    </span>
                  </div>
                </a>
              </li>
            </ul>
          </div>


          <!-- cart modal -->
          {% include 'partials/side_cart.html' %}
          <!-- cart modal -->
        </nav>
        
      </header>

      <div style="min-height: 80vh;">
      {% block all_content %}
        {% nevercache %}
          {% if messages %}
          <!-- <div class="messages">
            {% for message in messages %}
              <div class="alert alert-dismissable alert-{{ message.tags }}" data-alert="alert">
                <button type="button" class="close" data-dismiss="alert"aria-hidden="true">&times;</button>
                {{ message }}
              </div>
            {% endfor %}
          </div> -->
          {% endif %}
        {% endnevercache %}
        
        {% block topbar %}{% endblock %}

        {% block main_wrapper %}
          {% block main %}{% endblock %}
        {% endblock %}
      {% endblock %}
      </div>

      <!-- Footer -->
      {% if 'accounts' not in request.path %}
      {% include 'partials/footer.html' %}
      {% endif %}

    </div>
    

    {% compress js %}
      <script>
        var static_url = "{% get_static_prefix %}"
        var media_url = "{% get_media_prefix %}"
      </script>
    {% endcompress %}

    {% render_bundle "style" "js" %}

    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script>
      // Axios config
      axios.defaults.headers = {'X-CSRFToken': '{{csrf_token}}'}
      
      // Cart vue handels everything related to cart
      const NavVue = new Vue({
        el: '#navVue',
        delimiters: ['((', '))'],
        data: {
          cart: {
            shown: false,
            items: [],
            total_price: 0,
            delivery_fee: 0,
            remaining_budget: 0,
            attending_dinner: 0
          },
          notification: {
            text: '',
            shown: false,
            typeClass: 'success'
          },

          showNavDropdown: false,
          showUserDropdown: false,
        },

        watch: {
          'notification.shown': function(val) {
            if (val) {
              setTimeout(() => {
                if (this.notification.text.length < 65) this.notification.shown = false
              }, 3000);
            }
          }
        },
        
        methods: {
          async fetchCart() {
            try {
              const res = await axios.get('/api/cart/');
              const { id, items, total_price, delivery_fee, remaining_budget, attending_dinner } = res.data
              console.log(res.data)
              this.cart.items = items;
              this.cart.total_price = total_price;
              this.cart.delivery_fee = delivery_fee;
              this.cart.remaining_budget = remaining_budget;
              this.cart.attending_dinner = attending_dinner;
            } catch (error) {
              console.log('Can not fetch Cart')
            }
          },
          async addToCart(variation) {
            // Add item to session cart
            const res = await axios.post(`/api/product_variations/${variation.id}/add_to_cart/`)

            ProductsVue.hideProductModal();
            this.cart.shown = true;
            this.fetchCart();
          },
          async removeCartItem(item) {
            // remove an item from cart
            const res = await axios.post(`/api/cart/${item.id}/remove_item/`);
            this.fetchCart()
          },
          async clearCart() {
            // remove all items from cart and rest attending_dinner to 0
            const res = await axios.post('/api/cart/clear/');
            this.fetchCart()
          },
        
          // per item
          async increaseItemQuantity(item, event) {
            // increase CartItem quantity
            const controlContainer = event.target.parentElement
            // disable buttons
            controlContainer.querySelectorAll('button').forEach(btn => btn.disabled = true);
            
            try {
              const res = await axios.post(`/api/cart/${item.id}/increase_item/`);
              this.fetchCart();
              // enable buttons
              controlContainer.querySelectorAll('button').forEach(btn => btn.disabled = false);
            } catch (error) {
              console.log(error)
              // enable buttons
              controlContainer.querySelectorAll('button').forEach(btn => btn.disabled = false);
            }
          },
          async decreaseItemQuantity(item, event) {
            // increase CartItem quantity
            const controlContainer = event.target.parentElement
            // disable buttons
            controlContainer.querySelectorAll('button').forEach(btn => btn.disabled = true);
            
            try {
              const res = await axios.post(`/api/cart/${item.id}/decrease_item/`);
              this.fetchCart();
              // enable buttons
              controlContainer.querySelectorAll('button').forEach(btn => btn.disabled = false);
            } catch (error) {
              console.log(error)
              // enable buttons
              controlContainer.querySelectorAll('button').forEach(btn => btn.disabled = false);
            }
          },
          

          show_msg(msg, type='success') {
            this.notification.shown = true
            this.notification.text = msg
            
            // show border color based on the message type
            switch (type) {
              case 'success':
                this.notification.typeClass = 'border-green'
                break;
              case 'error':
                this.notification.typeClass = 'border-danger'
                break;
            }
          }
        },

        computed: {},

        async mounted() {
          // get the cart using user session
          this.fetchCart()
        }

      })


      // generic quit out listener (for the user dropdown menu)
      window.addEventListener('click', event => {
        if (event.target.id !== "username" && event.target.parentElement.id !== "username") {
          if (NavVue.showUserDropdown) NavVue.showUserDropdown = false
        }
      })
    </script>

    <script defer>
      // intial loading
      window.addEventListener('DOMContentLoaded', e => {
        document.querySelector('#main-spinner').classList.add('hidden')
        document.querySelector('#wrapper').classList.remove('hidden')
      })


      // close side-cart if open
      document.addEventListener('keyup', e => {
        if (e.key === "Escape") {
          NavVue.cart.shown = false;
        }
      })
    </script>

    {% block js %}{% endblock %}
  </body>
</html>
